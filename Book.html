<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <title>Booking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://cdn.tailwindcss.com" defer></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js" defer></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+Thai:wght@400;700&display=swap"
        rel="stylesheet" />

    <style>
        :root {
            /* Primary */
            --primary: #2f1a87;
            --primary-light: #7a6bb6;
            /* Backgrounds */
            --bg: #ffffff;
            /* main page bg */
            --bg-card: #f8f8fb;
            /* card & popup content */
            --bg-element: #ffffff;
            /* input, select, element bg */
            /* Borders */
            --border: #e5e7eb;
            /* gray-200 for visible border */
            /* Overlays */
            --overlay-bg: rgba(47, 26, 135, 0.5);
            /* primary semi-transparent */
            --popup-overlay: #00000066;
            /* dark overlay behind popup */
            /* Text */
            --text-main: #2f1a87;
            /* gray-800 */
            --text-main2: #654dc5;
            /* gray-800 */
            --text-placeholder: #9ca3af;
            /* gray-400 */
            --text-error: #f87171;
            /* red-400 */
            /* Badges */
            --badge-available-bg: #dcfce7;
            /* green-50 */
            --badge-available-text: #059669;
            /* green-600 */
            --badge-full-bg: #fee2e2;
            /* red-50 */
            --badge-full-text: #b91c1c;
            /* red-700 */
        }

        /* Utility classes */
        .bg-base {
            background-color: var(--bg) !important;
        }

        .bg-card {
            background-color: var(--bg-card) !important;
        }

        .bg-element {
            background-color: var(--bg-element) !important;
        }

        .border-element {
            border: 1px solid var(--border) !important;
        }

        .text-base {
            color: var(--text-main) !important;
        }

        .text-placeholder {
            color: var(--text-placeholder) !important;
        }

        .text-error {
            color: var(--text-error) !important;
        }

        /* Overlays */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay-bg);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }

        .loading-overlay.visible {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        /* ---- Loading Animation ---- */
        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid #FFF;
            border-bottom-color: var(--primary);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        .service-loader {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-bottom-color: var(--primary);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin-right: 12px;
        }

        .loading-text {
            color: var(--text-placeholder);
            font-size: 0.9rem;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--popup-overlay);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }

        .popup.visible {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        .popup-content {
            background: var(--bg-card);
            color: var(--text-main);
            padding: 1.5rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', 'Noto Sans Thai', sans-serif;
            margin: 0;
            background-color: var(--bg);
            color: var(--text-main);
            overscroll-behavior-y: contain;
        }

        ::selection {
            background-color: var(--primary);
            color: #fff;
            opacity: 0;
            transition: opacity 0.4s ease-in;
        }

        input[type='text'],
        input[type='tel'],
        textarea,
        select {
            background-color: var(--bg-element);
            border: 1px solid var(--border);
            color: var(--text-main);
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        input::placeholder,
        textarea::placeholder {
            color: var(--text-placeholder);
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.5);
        }

        #inlineCalendar-wrapper {
            background-color: var(--bg-card);
            padding: 0.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }

        .flatpickr-calendar {
            background: transparent !important;
            box-shadow: none !important;
            width: 100% !important;
            max-width: 320px;
            margin: auto;
        }

        .flatpickr-day {
            color: var(--text-main) !important;
            background: transparent !important;
            border-radius: 0.375rem;
            margin: 1px;
            width: 40px !important;
            height: 40px !important;
            line-height: 40px !important;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .flatpickr-day:hover {
            background-color: var(--bg-element);
        }

        .flatpickr-day.today {
            border-color: var(--primary-light) !important;
        }


        .flatpickr-day.selected {
            background: var(--primary) !important;
            color: #fff !important;
        }

        /* Holiday day style for flatpickr */
        .flatpickr-day.holiday-day {
            background: #fee2e2 !important; /* red-100 */
            color: #b91c1c !important;      /* red-700 */
            border-radius: 0.375rem !important;
        }

        .flatpickr-day.flatpickr-disabled,
        .flatpickr-day.prevMonthDay,
        .flatpickr-day.nextMonthDay {
            color: var(--text-placeholder) !important;
            opacity: 0.6;
            cursor: default;
        }

        .flatpickr-day.prevMonthDay,
        .flatpickr-day.nextMonthDay {
            visibility: hidden;
        }

        #timeDropdown {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.75rem;
        }

        .time-option {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background: var(--bg-element);
            color: var(--text-main);
            border: 1px solid transparent;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease;
        }

        .time-option:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .time-option.selected {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        .badge {
            border-radius: 9999px;
            padding: 0.125rem 0.5rem;
            font-size: 0.7rem;
            font-weight: 600;
            min-width: 3rem;
            text-align: center;
        }

        .badge.available {
            background: var(--badge-available-bg);
            color: var(--badge-available-text);
        }

        .badge.full {
            background: var(--badge-full-bg);
            color: var(--badge-full-text);
        }

        .time-option.opacity-50 {
            opacity: 0.6;
            pointer-events: none;
            background-color: var(--border);
        }

        .time-option.opacity-50:hover {
            transform: none;
            border-color: transparent;
        }

        .step {
            padding: 1rem;
            border-radius: 0.75rem;
            transition: opacity 0.35s ease, transform 0.35s ease;
        }

        .step:not(.step-active) {
            opacity: 0;
            transform: translateY(15px);
            pointer-events: none;
        }

        .step.step-active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        #serviceCards .service-card {
            background: var(--bg-element);
            border: 1px solid var(--border);
            color: var(--text-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        #serviceCards .service-card:hover {
            border-color: var(--primary-light);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(47, 26, 135, 0.15);
        }

        #serviceCards .service-card.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(47, 26, 135, 0.25);
        }

        .service-card .checkmark {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: #10b981;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            animation: checkmark-pop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .service-card.selected .checkmark {
            display: flex;
        }

        @keyframes checkmark-pop {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(180deg);
            }
            100% {
                transform: scale(1) rotate(180deg);
                opacity: 1;
            }
        }

        .checkmark svg {
            width: 14px;
            height: 14px;
            stroke: white;
            stroke-width: 2;
            fill: none;
        }

        .btn {
            padding: 0.875rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: none;
            outline: none;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:active:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-light);
        }

        .btn-secondary {
            background: var(--bg-element);
            color: var(--text-main);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--border);
        }

        .btn-loading {
            pointer-events: none;
        }

        .btn-loading::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin-top: -10px;
            margin-left: -10px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: rotation 1s linear infinite;
        }
    </style>
</head>

<body class="bg-gradient-to-b from-gray-100 via-gray-50 to-white min-h-screen relative bg-fixed ">
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
    </div>
    <div class="popup" id="popup">
        <div class="popup-content" id="popupContent"></div>
    </div>

    <div id="appContainer" class="w-full max-w-md mx-auto p-4 flex-1 flex flex-col"
        style="opacity: 0; transition: opacity 0.5s ease-in-out;">
        <div id="header" class="flex items-center border bg-white rounded-lg p-4">
            <img id="greetingAvatar" src alt="Avatar"
                class="w-12 h-12 rounded-full object-cover border-2 border-element mr-4" />
            <div>
                <p id="greetingPrefix" class="text-base">สวัสดีตอนเช้า</p>
                <h1 id="greetingName" class="text-primary font-bold text-lg"> LINE NAME </h1>
            </div>
            <div class="ml-auto">
                <select id="languageSwitcher"
                    class="bg-element border-element rounded-md p-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-light">
                    <option value="th">ไทย</option>
                    <option value="en">English</option>
                    <option value="my">မြန်မာ</option>
                </select>
            </div>
        </div>

        <form id="bookingForm" novalidate class="flex flex-col flex-1 relative">
            <div class="step step-active" id="step1">
                <label class="block mb-3 text-lg text-center text-base font-semibold"
                    data-translate-key="step1.title"></label>
                <div id="serviceCards" class="grid grid-cols-2 gap-4 mb-6"></div>
                <button type="button" id="nextToStep2" class="btn btn-primary w-full"
                    data-translate-key="step1.button"></button>
            </div>

            <div class="step hidden" id="step2">
                <label class="block mb-1 text-center text-base font-semibold"
                    data-translate-key="step2.dateLabel"></label>
                <div id="inlineCalendar-wrapper" class="mb-4">
                    <div id="inlineCalendar"></div>
                </div>
                <label class="block mb-2 text-center text-base font-semibold"
                    data-translate-key="step2.timeLabel"></label>
                <div id="timeDropdown" class="mb-6 min-h-[50px]">
                    <div class="text-placeholder text-sm text-center py-2 col-span-full"
                        data-translate-key="step2.placeholder"></div>
                </div>
                <div class="flex space-x-3">
                    <button type="button" id="backToStep1" class="btn btn-secondary flex-1"
                        data-translate-key="step2.back"></button>
                    <button type="button" id="nextToStep3" class="btn btn-primary flex-1"
                        data-translate-key="step2.next"></button>
                </div>
            </div>

            <div class="step hidden" id="step3">
                <label class="block mb-3 text-lg text-center text-base font-semibold" data-translate-key="step3.title"></label>
                <div class="flex gap-2 mb-3">
                    <input type="text" id="first_name" name="first_name" data-translate-key-placeholder="step3.firstNamePlaceholder" placeholder="ชื่อจริง" class="border-element flex-1" required />
                    <input type="text" id="last_name" name="last_name" data-translate-key-placeholder="step3.lastNamePlaceholder" placeholder="นามสกุล" class="border-element flex-1" required />
                </div>
                <input type="tel" id="phonenumber" name="phonenumber" data-translate-key-placeholder="step3.phonePlaceholder" placeholder="เบอร์ติดต่อ" class="mb-3 border-element" required />
                <input type="text" id="id_card_or_social" name="id_card_or_social" data-translate-key-placeholder="step3.idCardOrSocialPlaceholder" placeholder="เลขที่บัตรประชาชน/เลขที่ประกันสังคม" class="mb-3 border-element" required />
                <input type="text" id="disease_allergy" name="disease_allergy" data-translate-key-placeholder="step3.diseaseAllergyPlaceholder" placeholder="โรคประจำตัว/อาการแพ้ (ถ้ามี)" class="mb-3 border-element" />
                <textarea id="note" name="note" rows="3" data-translate-key-placeholder="step3.notePlaceholder" placeholder="หมายเหตุ (ถ้ามี)" class="mb-6 p-2 resize-none border-element"></textarea>
                <div class="flex space-x-3">
                    <button type="button" id="backToStep2" class="btn btn-secondary flex-1" data-translate-key="step3.back"></button>
                    <button type="button" id="nextToStep4" class="btn btn-primary flex-1" data-translate-key="step3.next"></button>
                </div>
            </div>

            <div class="step hidden" id="step4">
                <label class="block mb-3 text-lg text-center text-base font-semibold"
                    data-translate-key="step4.title"></label>
                <div class="bg-card p-4 rounded-lg mb-6 space-y-3">
                    <div class="flex justify-between items-center border-b pb-2"><span
                            data-translate-key="step4.serviceLabel"></span><span id="confirmService"
                            class="font-semibold"></span></div>
                    <div class="flex justify-between items-center border-b pb-2"><span
                            data-translate-key="step4.dateLabel"></span><span id="confirmDate"
                            class="font-semibold"></span></div>
                    <div class="flex justify-between items-center border-b pb-2"><span
                            data-translate-key="step4.timeLabel"></span><span id="confirmTime"
                            class="font-semibold"></span></div>
                    <div class="flex justify-between items-center border-b pb-2"><span
                            data-translate-key="step4.nameLabel"></span><span id="confirmName"
                            class="font-semibold text-right"></span></div>
                    <div class="flex justify-between items-center border-b pb-2"><span
                            data-translate-key="step4.phoneLabel"></span><span id="confirmPhone"
                            class="font-semibold"></span></div>
                    <div class="flex justify-between items-center border-b pb-2"><span
                            data-translate-key="step4.idCardOrSocialLabel"></span><span id="confirmIdCardOrSocial"
                            class="font-semibold text-right"></span></div>
                    <div class="flex justify-between items-center border-b pb-2"><span
                            data-translate-key="step4.diseaseAllergyLabel"></span><span id="confirmDiseaseAllergy"
                            class="font-semibold text-right"></span></div>
                    <div class="flex justify-between items-start pt-1"><span
                            data-translate-key="step4.noteLabel"></span><span id="confirmNote"
                            class="font-semibold text-right max-w-[60%] break-words"></span></div>
                </div>
                <div class="flex space-x-3">
                    <button type="button" id="backToStep3" class="btn btn-secondary flex-1"
                        data-translate-key="step4.back"></button>
                    <button type="submit" id="confirmBooking" class="btn btn-primary flex-1"
                        data-translate-key="step4.confirm"></button>
                </div>
            </div>

            <input type="hidden" id="time" name="time" /><input type="hidden" id="selectedServices"
                name="selectedServices" /><input type="hidden" id="selectedServiceNames"
                name="selectedServiceNames" /><input type="hidden" id="userlineid" name="userlineid" value /><input
                type="hidden" name="action" value="makeBooking" />
        </form>
    </div>

    <script src="language.js"></script>
    <script src="Config.js"></script>

    <script>
        const ENABLE_LIFF = false;
        const $ = (id) => document.getElementById(id);

        const defaultLang = 'th';
        let currentLang = defaultLang;

        let monthAvailability = {}, selectedDate = '';
        let currentVisibleStep = 'step1';
        let flatpickrInstance = null;
        let servicesLoaded = false;

        const t = (key) => translations[currentLang]?.[key] || key;

        // ฟังก์ชันแปลชื่อบริการ (เข้มแข็ง: trim/normalize และลองหลาย fallback)
        function normalizeServiceKey(name) {
            if (!name && name !== 0) return '';
            // trim whitespace and normalize multiple spaces
            return String(name).replace(/\s+/g, ' ').trim();
        }

        function translateServiceName(serviceName, lang = currentLang) {
            const orig = normalizeServiceKey(serviceName);
            if (!orig) return serviceName || '';

            const tryKeys = [
                `service.${orig}`,
                `service.${orig.replace(/\s+/g, '')}` // fallback without spaces
            ];

            for (const k of tryKeys) {
                const v = translations[lang]?.[k];
                if (v) return v;
            }

            // last resort: try other langs to see if any mapping exists
            for (const L of Object.keys(translations)) {
                for (const k of tryKeys) {
                    const v = translations[L]?.[k];
                    if (v) return v;
                }
            }

            // ถ้าไม่พบ ให้คืนค่าเดิม (แต่ normalized)
            return orig;
        }
        
        // ฟังก์ชันอัปเดตภาษาของบริการ
        function updateServiceLanguage(lang, targetContainer = null) {
            const serviceCards = targetContainer || $('#serviceCards');
            if (!serviceCards) return;

            [...serviceCards.children].forEach(card => {
                const originalName = normalizeServiceKey(card.dataset.originalName || card.dataset.name || '');
                const translatedName = translateServiceName(originalName, lang);
                const nameDiv = card.querySelector('.font-bold');
                if (nameDiv) nameDiv.textContent = translatedName;
            });
        }

        function loadFlatpickrLocale(lang) {
            return new Promise((resolve) => {
                if (lang === 'en') return resolve();

                const existingScript = document.getElementById('flatpickr-locale-script');
                if (existingScript) existingScript.remove();

                if (lang === 'my') return resolve();

                const script = document.createElement('script');
                script.id = 'flatpickr-locale-script';
                script.src = `https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/${lang}.js`;
                script.onload = () => resolve();
                script.onerror = () => {
                    console.error(`Failed to load Flatpickr locale for ${lang}`);
                    resolve();
                };
                document.head.appendChild(script);
            });
        }

        async function setLanguage(lang) {
            console.log('setLanguage called with:', lang);
            currentLang = translations[lang] ? lang : defaultLang;
            console.log('currentLang set to:', currentLang);
            localStorage.setItem('booking_lang', currentLang);
            document.documentElement.lang = currentLang;

            // สร้างฟังก์ชัน t แบบ local สำหรับภาษาใหม่
            const tLocal = (key) => translations[currentLang]?.[key] || key;

            document.querySelectorAll('[data-translate-key]').forEach(el => {
                el.textContent = tLocal(el.dataset.translateKey);
            });
            document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
                el.placeholder = tLocal(el.dataset.translateKeyPlaceholder);
            });

            // อัปเดตข้อความทักทาย
            $('greetingPrefix').textContent = tLocal(getGreeting(new Date().getHours()));

            await loadFlatpickrLocale(currentLang);
            if (flatpickrInstance) {
                flatpickrInstance.destroy();
                initCalendar();
                if (selectedDate) flatpickrInstance.setDate(selectedDate, false);
            }

            if (!selectedDate) {
                const timeDropdownEl = $('#timeDropdown');
                if (timeDropdownEl) {
                    timeDropdownEl.innerHTML = `<div class="text-placeholder text-sm text-center py-2 col-span-full">${tLocal('step2.placeholder')}</div>`;
                }
            }
            
            // อัปเดตชื่อบริการ แบบ force update (รองรับกรณี race)
            try {
                const serviceCards = $('#serviceCards');
                if (serviceCards) {
                    updateServiceLanguage(currentLang, serviceCards);
                    // อัปเดตชื่อบริการที่เลือกไว้
                    updateSelectedServices();
                } else {
                    console.debug('setLanguage: #serviceCards not found yet');
                }
            } catch (e) {
                console.warn('setLanguage: failed to update service names', e);
            }
            // รีโหลด services เสมอเมื่อเปลี่ยนภาษา เพื่อให้แน่ใจว่าชื่อและข้อมูลตรงกับภาษาปัจจุบัน
            try {
                console.debug('setLanguage: refetching services to refresh titles');
                await fetchServiceData();
            } catch (e) {
                console.warn('setLanguage: fetchServiceData failed', e);
            }
            // อัปเดตข้อมูลใน step4 ถ้าอยู่ในหน้านั้น
            if (currentVisibleStep === 'step4') {
                updateConfirmation();
            }
            
        }

        function showLoading(on) {
            const overlay = $('loadingOverlay');
            if (on) {
                overlay.style.display = 'flex';
                setTimeout(() => overlay.classList.add('visible'), 10);
            } else {
                overlay.classList.remove('visible');
                setTimeout(() => {
                    if (!overlay.classList.contains('visible'))
                        overlay.style.display = 'none';
                }, 300);
            }
        }

        // inline service-loading UI (spinner inside serviceCards) and control disabling
        function setServiceLoading(on) {
            const container = $('serviceCards');
            const nextBtn = $('nextToStep2');
            const langSwitch = $('languageSwitcher');
            if (!container) return;
            if (on) {
                // show enhanced loading state with spinner and text
                container.innerHTML = `
                    <div class="col-span-2 flex flex-col items-center justify-center py-8">
                        <div class="flex items-center mb-3">
                            <div class="service-loader"></div>
                            <span class="loading-text">${t('service.loading') || 'กำลังโหลดบริการ...'}</span>
                        </div>
                    </div>
                `;
                if (nextBtn) {
                    nextBtn.disabled = true;
                    nextBtn.classList.add('btn-loading');
                }
                if (langSwitch) {
                    langSwitch.disabled = true;
                    langSwitch.style.opacity = '0.6';
                }
            } else {
                // re-enable controls; content will be refreshed by fetchServiceData
                if (nextBtn) {
                    nextBtn.disabled = false;
                    nextBtn.classList.remove('btn-loading');
                }
                if (langSwitch) {
                    langSwitch.disabled = false;
                    langSwitch.style.opacity = '1';
                }
            }
        }

        function showPopup(msgKey, isSuccess = false, isRawMessage = false) {
            const msg = isRawMessage ? msgKey : t(msgKey);
            showLoading(false);
            const icon = isSuccess ?
                `<svg class="w-12 h-12 text-base mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>` :
                `<svg class="w-12 h-12 text-error mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;

            $('popupContent').innerHTML = `
          <div class="py-4 text-center">${icon}<p>${msg}</p></div>
          <div class="mt-4 text-center">
            <button onclick="hidePopup()" class="btn btn-secondary w-full sm:w-auto px-6">${t('popup.close')}</button>
          </div>`;
            const popupEl = $('popup');
            popupEl.style.display = 'flex';
            setTimeout(() => popupEl.classList.add('visible'), 10);
        }

        function hidePopup() {
            const popupEl = $('popup');
            popupEl.classList.remove('visible');
            setTimeout(() => {
                if (!popupEl.classList.contains('visible'))
                    popupEl.style.display = 'none';
            }, 300);
        }

        function navigateToStep(target) {
            if (currentVisibleStep === target) return;
            const prev = $(currentVisibleStep),
                next = $(target);
            prev.classList.remove('step-active');
            prev.addEventListener('transitionend', function onEnd() {
                prev.classList.add('hidden');
                prev.removeEventListener('transitionend', onEnd);
            });
            next.classList.remove('hidden');
            requestAnimationFrame(() => next.classList.add('step-active'));
            currentVisibleStep = target;
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function getGreeting(hour) {
            if (hour < 12) return 'greeting.morning';
            if (hour < 13) return 'greeting.noon';
            if (hour < 17) return 'greeting.afternoon';
            if (hour < 19) return 'greeting.evening';
            return 'greeting.night';
        }

        async function initLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) return liff.login();
                const p = await liff.getProfile();
                $('greetingName').textContent = p.displayName;
                if (p.pictureUrl) $('greetingAvatar').src = p.pictureUrl;
                else $('greetingAvatar').style.display = 'none';
                $('userlineid').value = p.userId;
            } catch {
                offlineProfile();
            }
        }

        function offlineProfile() {
            $('greetingName').textContent = 'ผู้ใช้งานทดสอบ';
            $('greetingAvatar').style.display = 'none';
            $('userlineid').value = 'OFFLINE';
        }

        async function fetchMonthAvailability(year, month) {
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getMonthAvailability&year=${year}&month=${('0' + month).slice(-2)}`);
                if (!res.ok) throw new Error();
                monthAvailability = await res.json();
            } catch {
                monthAvailability = {};
                showPopup('popup.calendarError');
            }
        }

        async function fetchServiceData() {
            // show inline loading in the services area and disable related controls
            setServiceLoading(true);
            try {
                const res = await fetch(`${WEB_APP_URL}?action=fetchServices`);
                if (!res.ok) throw new Error();
                const services = await res.json();
                const container = $('serviceCards');
                if (!services.length) {
                    container.innerHTML = `<p class="text-center col-span-2">${t('service.noService')}</p>`;
                    servicesLoaded = true;
                    return;
                }
                container.innerHTML = '';
                services.forEach((s, index) => {
                    const c = document.createElement('div');
                    c.className = 'service-card p-8 border-element rounded-lg cursor-pointer shadow-sm';
                    c.dataset.id = s.id;
                    c.dataset.name = s.name;
                    c.dataset.originalName = normalizeServiceKey(s.name || ''); // เก็บชื่อต้นฉบับ (normalized)
                    c.dataset.price = s.price;
                    const translatedName = translateServiceName(c.dataset.originalName, currentLang);
                    c.innerHTML = `
                        <div class="font-bold text-md mb-1 text--primary-light">${translatedName}</div>
                        <div class="checkmark">
                            <svg viewBox="0 0 24 24">
                                <polyline points="20,6 9,17 4,12"></polyline>
                            </svg>
                        </div>
                    `;
                    c.onclick = () => {
                        c.classList.toggle('selected');
                        // Add haptic feedback simulation
                        c.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            c.style.transform = '';
                        }, 150);
                        updateSelectedServices();
                    };
                    // Staggered animation for smooth appearance
                    c.style.opacity = '0';
                    c.style.transform = 'translateY(20px)';
                    container.appendChild(c);
                    setTimeout(() => {
                        c.style.opacity = '1';
                        c.style.transform = 'translateY(0)';
                    }, index * 100);
                    // Debug: log created card info
                    try {
                        console.debug('fetchServiceData: created card', { id: c.dataset.id, originalName: c.dataset.originalName, translated: translatedName });
                    } catch (e) { /* ignore */ }
                });
                
                    // อัปเดตชื่อบริการให้ตรงกับภาษาปัจจุบันหลังสร้าง service cards
                    updateServiceLanguage(currentLang, container);
                    servicesLoaded = true;
            } catch (err) {
                console.error('fetchServiceData error', err);
                showPopup('popup.serviceError');
            } finally {
                // hide inline loading and re-enable controls
                setServiceLoading(false);
            }
        }

        async function fetchHolidayDates() {
            try {
                const res = await fetch(`${WEB_APP_URL}?action=checkAvailability&getHolidays=true`);
                if (!res.ok) throw new Error();
                const j = await res.json();
                // รับค่าทั้งวันหยุดพิเศษ และวันหยุดประจำสัปดาห์
                window.holidayDates = Array.isArray(j.holidays) ? j.holidays : [];
                window.permanentHolidayDays = Array.isArray(j.permanentHolidays) ? j.permanentHolidays : [];
            } catch {
                window.holidayDates = [];
                window.permanentHolidayDays = [];
            }
        }

        function formatDate(d) {
            const y = d.getFullYear();
            const m = ('0' + (d.getMonth() + 1)).slice(-2);
            const da = ('0' + d.getDate()).slice(-2);
            return `${y}-${m}-${da}`;
        }

        function initCalendar() {
            const localeMap = {
                th: window.flatpickr.l10ns.th,
                en: window.flatpickr.l10ns.default,
                my: window.flatpickr.l10ns.default
            };
            const customLocale = {
                ...localeMap[currentLang], // คัดลอกค่าภาษาที่เลือกมาทั้งหมด
                firstDayOfWeek: 0 // กำหนดให้วันอาทิตย์ (0) เป็นวันแรก
            };
            flatpickrInstance = flatpickr('#inlineCalendar', {
                inline: true,
                locale: customLocale,
                dateFormat: 'Y-m-d',
                minDate: 'today',
                disable: [(d) => {
                    const k = formatDate(d);
                    const isPermanentHoliday = (window.permanentHolidayDays || []).includes(d.getDay());
                    return isPermanentHoliday || (window.holidayDates || []).includes(k) || monthAvailability[k] === 'full';
                }],
                onDayCreate: (dObj, dStr, fp, dayElem) => {
                    const k = formatDate(dayElem.dateObj);
                    const date = dayElem.dateObj;
                    const isSpecialHoliday = (window.holidayDates || []).includes(k);
                    const isPermanentHoliday = (window.permanentHolidayDays || []).includes(date.getDay());
                    if (isSpecialHoliday || isPermanentHoliday) {
                        dayElem.classList.add('holiday-day');
                        // Show only the date number (remove extra text)
                        dayElem.innerHTML = `<span>${date.getDate()}</span>`;
                    }
                },
                onMonthChange: async (_, __, fp) => {
                    showLoading(true);
                    await fetchMonthAvailability(fp.currentYear, fp.currentMonth + 1);
                    fp.redraw();
                    showLoading(false);
                },
                onChange: (_, dateStr) => {
                    selectedDate = dateStr;
                    if (dateStr) checkAvailability(dateStr);
                    else $('timeDropdown').innerHTML = `<div class="text-placeholder text-sm text-center py-2 col-span-full">${t('step2.placeholder')}</div>`;
                },
            });
        }

        async function checkAvailability(dateStr) {
            $('timeDropdown').innerHTML = `<div class="text-placeholder text-sm text-center py-2 col-span-full">${t('step2.loading')}</div>`;
            try {
                const res = await fetch(`${WEB_APP_URL}?action=checkAvailability&date=${dateStr}`);
                if (!res.ok) throw new Error();
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                renderTimes(data.availability);
            } catch (e) {
                $('timeDropdown').innerHTML = `<div class="text-error text-sm text-center py-2 col-span-full">${t('step2.error')}</div>`;
                showPopup(e.message || 'popup.timeError', false, true);
            }
        }

        function renderTimes(avail) {
            const td = $('timeDropdown');
            td.innerHTML = '';
            if (!Object.keys(avail).length) {
                td.innerHTML = `<div class="text-placeholder text-sm text-center py-2 col-span-full">${t('step2.noTime')}</div>`;
                return;
            }
            Object.entries(avail).forEach(([t, i]) => {
                const div = document.createElement('div');
                div.className = `time-option ${i.remaining > 0 ? '' : 'opacity-50'}`;
                div.innerHTML = `<span>${t}</span><span class="badge ${i.remaining > 0 ? 'available' : 'full'}">${i.remaining}/${i.total}</span>`;
                if (i.remaining > 0) div.onclick = () => selectTime(t, div);
                td.appendChild(div);
            });
        }

        function selectTime(t, el) {
            [...$('timeDropdown').children].forEach((c) => c.classList.remove('selected'));
            el.classList.add('selected');
            $('time').value = t;
        }

        function updateSelectedServices() {
            const serviceCardsEl = $('serviceCards');
            if (!serviceCardsEl) return;
            const sel = [...serviceCardsEl.children].filter((c) => c.classList.contains('selected'));
            $('selectedServices').value = JSON.stringify(sel.map((c) => c.dataset.id));
            $('selectedServiceNames').value = sel.map((c) => translateServiceName(normalizeServiceKey(c.dataset.originalName || c.dataset.name || ''), currentLang)).join(', ');
            
            // Update button state based on selection
            const nextBtn = $('nextToStep2');
            if (nextBtn) {
                if (sel.length > 0) {
                    nextBtn.classList.remove('opacity-50');
                    nextBtn.style.background = 'var(--primary)';
                } else {
                    nextBtn.classList.add('opacity-50');
                }
            }
            
            // Add subtle visual feedback for selection count
            if (sel.length > 0) {
                serviceCardsEl.style.transform = 'scale(1.01)';
                setTimeout(() => {
                    serviceCardsEl.style.transform = 'scale(1)';
                }, 200);
            }
        }

        function updateConfirmation() {
            // ดึงชื่อบริการที่เลือกและแปลให้ตรงกับภาษาปัจจุบัน
            const selectedCards = [...$('serviceCards').children].filter(c => c.classList.contains('selected'));
            const translatedServiceNames = selectedCards.map(c => translateServiceName(c.dataset.originalName || c.dataset.name, currentLang));
            const raw = translatedServiceNames.join(', ') || '-';
            
            const el = $('confirmService');
            if (raw.includes(', ')) {
                el.innerHTML = raw.split(', ').map((s) => `<div>${s}</div>`).join('');
            } else {
                el.textContent = raw;
            }
            $('confirmDate').textContent = selectedDate ? selectedDate.split('-').reverse().join('/') : '-';
            $('confirmTime').textContent = $('time').value || '-';
            $('confirmName').textContent = `${$('first_name').value || ''} ${$('last_name').value || ''}`.trim() || '-';
            $('confirmPhone').textContent = $('phonenumber').value || '-';
            $('confirmIdCardOrSocial').textContent = $('id_card_or_social').value || '-';
            $('confirmDiseaseAllergy').textContent = $('disease_allergy').value || '-';
            $('confirmNote').textContent = $('note').value.trim() || '-';
        }

        $('nextToStep2').onclick = () => {
            if (!JSON.parse($('selectedServices').value || '[]').length) return showPopup('popup.serviceNeeded');
            navigateToStep('step2');
        };
        $('backToStep1').onclick = () => navigateToStep('step1');
        $('nextToStep3').onclick = () => {
            if (!selectedDate) return showPopup('popup.dateNeeded');
            if (!$('time').value) return showPopup('popup.timeNeeded');
            navigateToStep('step3');
        };
        $('backToStep2').onclick = () => navigateToStep('step2');
        $('nextToStep4').onclick = () => {
            if (!$('first_name').value.trim()) return showPopup('popup.firstNameNeeded');
            if (!$('last_name').value.trim()) return showPopup('popup.lastNameNeeded');
            if (!$('phonenumber').value.trim()) return showPopup('popup.phoneNeeded');
            if (!/^[0-9]{9,10}$/.test($('phonenumber').value.trim())) return showPopup('popup.phoneFormatError');
            if (!$('id_card_or_social').value.trim()) return showPopup('popup.idCardOrSocialNeeded');
            updateConfirmation();
            navigateToStep('step4');
        };
        $('backToStep3').onclick = () => navigateToStep('step3');

        $('bookingForm').onsubmit = async (e) => {
            e.preventDefault();
            showLoading(true);
            const fd = new FormData($('bookingForm'));
            fd.append('date', selectedDate);
            // ส่งข้อมูลใหม่
            fd.append('first_name', $('first_name').value.trim());
            fd.append('last_name', $('last_name').value.trim());
            fd.append('id_card_or_social', $('id_card_or_social').value.trim());
            fd.append('disease_allergy', $('disease_allergy').value.trim());
            try {
                const resp = await fetch(WEB_APP_URL, { method: 'POST', body: fd });
                const text = await resp.text();
                let result;
                try {
                    result = JSON.parse(text);
                } catch {
                    result = { success: resp.ok, message: text };
                }
                if (!result.success) throw new Error(result.message || t('popup.submitError'));
            } catch (err) {
                console.error('Submit error:', err);
                return showPopup(err.message || t('popup.submitError'), false, true);
            }
            showLoading(false);
            showPopup('popup.bookingSuccess', true);
            await sendFlexMessage();
            $('bookingForm').reset();
            updateSelectedServices();
            $('timeDropdown').innerHTML = `<div class="text-placeholder text-sm text-center py-2 col-span-full">${t('step2.placeholder')}</div>`;
            $('time').value = '';
            selectedDate = '';
            if (flatpickrInstance) flatpickrInstance.clear();
            navigateToStep('step1');
        };

        async function sendFlexMessage() {
            if (!liff.isInClient()) return;
            const servicesRaw = $('selectedServiceNames').value || '';
            const servicesList = servicesRaw.split(', ').filter(s => s.trim().length);
            const serviceContents = servicesList.map(s => ({ type: 'box', layout: 'horizontal', spacing: 'md', contents: [{ type: 'text', text: '•', size: 'sm', color: varToHex('--text-main2'), flex: 1 }, { type: 'text', text: s, size: 'sm', wrap: true, color: varToHex('--text-main2'), flex: 9 }] }));
            if (!serviceContents.length) { serviceContents.push({ type: 'text', text: '-', size: 'sm', color: varToHex('--text-main2') }); }

            const bubble = {
                type: 'bubble',
                header: { type: 'box', layout: 'vertical', backgroundColor: varToHex('--primary'), contents: [{ type: 'text', text: t('flex.header'), weight: 'bold', size: 'xs', align: 'center', color: '#ffffff' }] },
                body: {
                    type: 'box', layout: 'vertical', spacing: 'sm', paddingAll: 'xl', backgroundColor: varToHex('--bg-card'),
                    contents: [
                        { type: 'text', text: t('flex.serviceLabel') + ':', size: 'sm', color: varToHex('--text-main') },
                        ...serviceContents,
                        { type: 'separator', margin: 'md', color: varToHex('--text-main') },
                        makeFieldBox(t('flex.dateLabel'), selectedDate ? selectedDate.split('-').reverse().join('/') : '-'),
                        makeFieldBox(t('flex.timeLabel'), $('time').value || '-'),
                        { type: 'separator', margin: 'md', color: varToHex('--text-main') },
                        makeFieldBox(t('flex.nameLabel'), `${$('first_name').value || ''} ${$('last_name').value || ''}`.trim() || '-'),
                        makeFieldBox(t('flex.phoneLabel'), $('phonenumber').value || '-'),
                        makeFieldBox('เลขบัตร/ประกัน', $('id_card_or_social').value || '-'),
                        makeFieldBox('โรค/แพ้', $('disease_allergy').value || '-'),
                        makeFieldBox(t('flex.noteLabel'), $('note').value || '-')
                    ]
                },
                styles: { header: { separator: false } }
            };
            try {
                await liff.sendMessages([{ type: 'flex', altText: t('flex.altText'), contents: bubble }]);
            } catch (e) {
                console.error('Error sending flex message:', e);
            }
        }

        function varToHex(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        }

        function makeFieldBox(label, value) {
            return {
                type: 'box',
                layout: 'horizontal',
                contents: [{
                    type: 'text',
                    text: label + ':',
                    color: varToHex('--text-placeholder'),
                    size: 'sm',
                    flex: 2,
                }, {
                    type: 'text',
                    text: value,
                    color: varToHex('--text-main'),
                    size: 'sm',
                    wrap: true,
                    flex: 5,
                },],
            };
        }

        document.addEventListener('DOMContentLoaded', async () => {
            showLoading(true);
            $(currentVisibleStep).classList.add('step-active');
            $(currentVisibleStep).classList.remove('hidden');

            const savedLang = localStorage.getItem('booking_lang') || navigator.language.split('-')[0];
            $('languageSwitcher').value = translations[savedLang] ? savedLang : defaultLang;
            
            // แก้ไข event listener ให้ชัดเจน
            $('languageSwitcher').addEventListener('change', async (e) => {
                console.log('Language changed to:', e.target.value);
                await setLanguage(e.target.value);
                console.log('Language change completed');
            });

            await setLanguage($('languageSwitcher').value);

            if (ENABLE_LIFF) await initLiff(); else offlineProfile();

            await Promise.allSettled([
                fetchHolidayDates(),
                fetchMonthAvailability(new Date().getFullYear(), new Date().getMonth() + 1),
            ]);

            if (!flatpickrInstance) initCalendar();

            showLoading(false);
            $('appContainer').style.opacity = 1;
        });
    </script>
</body>

</html>